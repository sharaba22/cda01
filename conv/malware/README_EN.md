# Malware Detection via Binary-to-Image + CNN — Documentation (EN)

## Overview
This program classifies binaries (e.g., `.exe`, `.bin`) or already-converted images into **malware (1)** vs **benign (0)**. Raw bytes are converted to grayscale images (0–255), resized to a fixed resolution, and fed into a simple **Convolutional Neural Network (CNN)**. The notebook also produces **Grad-CAM** heatmaps for interpretability.

## Project layout & prerequisites
- **Python packages:** `numpy`, `pillow`, `matplotlib`, `tensorflow (keras)`, `scikit-learn`
- **Folder layout:** `malware_dataset/` with two subfolders:
  - `malware_dataset/malware/` — malware samples (images or binaries)
  - `malware_dataset/benign/` — benign samples (images or binaries)
- **Key config in code:**
  - `DATA_DIR = "./malware_dataset"`
  - `IMG_SIZE = 128` (try 64/96/128/224…)
  - `MAX_FILES = None` (limit for quick runs)

> Note: If your data are already images (PNG/JPG), the code reads them directly. If they are raw binaries, they are converted via `bytes_to_image`.

## Pipeline
1. **Binary → Image:** `bytes_to_image` reshapes bytes into a near-square 2D array and resizes to `IMG_SIZE×IMG_SIZE` (grayscale `"L"`).
2. **Dataset assembly:** crawl `benign/` and `malware/`, build `X` (N×H×W×1) and `y`.
3. **Normalization:** `X / 255.0` and expand channel `[..., np.newaxis]`.
4. **Split:** `train_test_split(..., stratify=y)` 80/20.
5. **CNN:** 3× (Conv+MaxPool) blocks → `Flatten → Dense(128) → Dense(1, sigmoid)`.
6. **Training:** `model.fit(..., epochs=5, batch_size=32)`.
7. **Evaluation:** `classification_report`, `confusion_matrix`, sample predictions.
8. **Grad-CAM:** heatmap from last conv activations + gradients wrt positive output.

## Grad-CAM — robust version (Keras 2/3)
With Keras 3 you may see `"The layer sequential has never been called..."` if `model.inputs/outputs` aren’t initialized. The provided robust code:
- auto-detects the last `Conv2D` layer,
- runs a one-step `predict` to ensure `inputs/outputs` exist,
- calls `grad_model([img_tensor], training=False)` to match expected input structure.

If you saw `"The structure of inputs..."` warning, it’s benign; passing a list eliminates it.

## Space-saving tips
- Prefer **pre-converted images** (PNG/JPG) over raw binaries.
- Lower `IMG_SIZE` (e.g., 64/96) to speed up and reduce memory.
- Limit samples per class (e.g., 100–300).
- When building a subset on Kaggle, pick a balanced selection (e.g., 200 benign / 200 malware).

## Common issues & fixes
- **Grad-CAM in Keras 3:** use the robust function in this doc.
- **Class imbalance:** use `class_weight` or oversampling.
- **IO errors:** corrupted files are skipped (`file_to_image` handles exceptions).
- **Kaggle download hiccups:** “Save Version → Output files” and download ZIP from there.

## How to run
1. Prepare `malware_dataset/benign` and `malware_dataset/malware` with images.
2. Run the notebook/script (`python malware_notebook.py`).
3. Inspect printed metrics, visualized samples, and the final Grad-CAM overlay.
